# 功能规范：下载引擎系统

## 项目信息

- **项目名称**: Stacks - Anna's Archive 下载管理器
- **规范版本**: 1.0.0
- **创建日期**: 2025-12-25
- **最后更新**: 2025-12-25
- **负责人**: 开发团队

---

## 宪法合规性检查

本功能规范必须遵循以下宪法原则：

- [x] **代码质量标准**: 明确代码风格、类型注解、错误处理要求
- [x] **测试标准**: 定义测试类型、覆盖率要求、测试命名规范
- [x] **用户体验一致性**: 明确界面风格、响应式设计、交互反馈要求
- [x] **性能要求**: 定义响应时间、并发处理、资源使用标准
- [x] **安全与隐私**: 明确认证授权、数据保护、输入验证要求
- [x] **文档与可维护性**: 定义文档类型、版本控制、依赖管理要求

---

## 功能概述

### 背景

Stacks 项目的核心功能是管理 Anna's Archive 的下载任务。下载引擎系统是整个系统的核心组件，负责实际执行文件下载操作。系统需要支持多种下载源，包括 Anna's Archive 的快速下载 API（会员功能）和多个镜像站点。为了确保下载的可靠性和效率，系统必须实现自动回退机制、下载中断恢复、重试机制等功能。

### 目标

- 提供高效可靠的下载引擎，支持多种下载源
- 实现自动回退机制，确保下载任务能够完成
- 支持下载中断恢复，避免重复下载
- 提供下载进度跟踪和速度监控功能
- 支持可配置的重试机制，提高下载成功率

### 范围

本规范涵盖下载引擎系统的所有核心功能，包括：
- 快速下载 API 支持
- 镜像站点下载引擎
- 自动回退机制
- 下载中断恢复
- 下载重试机制
- 下载进度跟踪
- 下载速度监控
- 多源下载支持

### 预期成果

- 一个稳定可靠的下载引擎，能够处理各种下载场景
- 支持多种下载源的灵活切换
- 完善的错误处理和重试机制
- 实时的下载进度和速度监控
- 高成功率的下载任务完成

---

## 功能需求

### 功能需求 1: 快速下载 API 支持

**描述**: 支持 Anna's Archive 的快速下载 API，允许会员用户使用 API 密钥进行高速下载。

**用户故事**: 作为 Anna's Archive 会员，我想要使用快速下载 API，以便更快地下载文件。

**验收标准**:
- [ ] 系统支持配置快速下载 API 密钥
- [ ] 系统能够使用 API 密钥进行快速下载
- [ ] 快速下载失败时能够记录错误信息
- [ ] 支持快速下载配额监控
- [ ] 支持启用/禁用快速下载功能
- [ ] 快速下载失败时能够自动回退到镜像站点

**优先级**: 高

**依赖项**: 配置管理系统、用户认证系统

---

### 功能需求 2: 镜像站点下载引擎

**描述**: 实现镜像站点下载引擎，支持从多个镜像站点下载文件。

**用户故事**: 作为系统用户，我想要从镜像站点下载文件，以便在快速下载不可用时仍能完成下载。

**验收标准**:
- [ ] 系统支持配置多个镜像站点
- [ ] 系统能够从镜像站点下载文件
- [ ] 支持镜像站点优先级配置
- [ ] 支持镜像站点可用性检测
- [ ] 镜像站点下载失败时能够切换到下一个镜像
- [ ] 支持镜像站点超时配置

**优先级**: 高

**依赖项**: 配置管理系统

---

### 功能需求 3: 自动回退机制

**描述**: 实现自动回退机制，当快速下载失败时自动切换到镜像站点下载。

**用户故事**: 作为系统用户，我想要系统在快速下载失败时自动尝试镜像站点，以便提高下载成功率。

**验收标准**:
- [ ] 快速下载失败时自动切换到镜像站点
- [ ] 支持配置回退策略（立即回退或延迟回退）
- [ ] 支持配置最大回退次数
- [ ] 回退过程记录详细日志
- [ ] 支持禁用自动回退功能
- [ ] 回退失败时能够标记任务为失败

**优先级**: 高

**依赖项**: 快速下载 API 支持、镜像站点下载引擎

---

### 功能需求 4: 下载中断恢复支持

**描述**: 支持下载中断恢复，避免重复下载已下载的部分。

**用户故事**: 作为系统用户，我想要在下载中断后能够恢复下载，以便节省时间和带宽。

**验收标准**:
- [ ] 系统能够检测已下载的部分文件
- [ ] 支持从断点继续下载
- [ ] 支持配置恢复尝试次数
- [ ] 恢复失败时能够重新下载
- [ ] 支持禁用恢复功能
- [ ] 恢复过程记录详细日志

**优先级**: 高

**依赖项**: 下载进度跟踪

---

### 功能需求 5: 下载重试机制

**描述**: 实现可配置的下载重试机制，提高下载成功率。

**用户故事**: 作为系统用户，我想要系统在下载失败时自动重试，以便提高下载成功率。

**验收标准**:
- [ ] 支持配置最大重试次数
- [ ] 支持配置重试延迟时间
- [ ] 支持配置重试间隔递增策略
- [ ] 重试过程记录详细日志
- [ ] 达到最大重试次数后标记任务为失败
- [ ] 支持禁用重试功能

**优先级**: 高

**依赖项**: 无

---

### 功能需求 6: 下载进度跟踪

**描述**: 实现下载进度跟踪功能，实时显示下载进度。

**用户故事**: 作为系统用户，我想要实时查看下载进度，以便了解下载状态。

**验收标准**:
- [ ] 系统能够实时跟踪下载进度
- [ ] 支持显示已下载字节数
- [ ] 支持显示总字节数
- [ ] 支持显示下载百分比
- [ ] 支持显示预计剩余时间
- [ ] 进度信息能够通过 API 获取

**优先级**: 高

**依赖项**: 无

---

### 功能需求 7: 下载速度监控

**描述**: 实现下载速度监控功能，实时显示下载速度。

**用户故事**: 作为系统用户，我想要实时查看下载速度，以便了解下载性能。

**验收标准**:
- [ ] 系统能够实时计算下载速度
- [ ] 支持显示当前下载速度
- [ ] 支持显示平均下载速度
- [ ] 支持显示峰值下载速度
- [ ] 速度信息能够通过 API 获取
- [ ] 支持速度单位自动转换（KB/s、MB/s）

**优先级**: 高

**依赖项**: 下载进度跟踪

---

### 功能需求 8: 多源下载支持

**描述**: 支持从多个下载源下载文件，提高下载成功率。

**用户故事**: 作为系统用户，我想要系统能够从多个源下载文件，以便在某个源不可用时仍能完成下载。

**验收标准**:
- [ ] 系统支持配置多个下载源
- [ ] 支持下载源优先级配置
- [ ] 支持下载源可用性检测
- [ ] 当前下载源失败时自动切换到下一个源
- [ ] 支持下载源超时配置
- [ ] 下载源切换过程记录详细日志

**优先级**: 高

**依赖项**: 配置管理系统

---

## 非功能需求

### 性能需求

- [ ] **下载速度**: 快速下载速度应达到 10MB/s 以上（取决于网络条件）
- [ ] **并发处理**: 系统必须支持至少 5 个并发下载任务
- [ ] **资源使用**: 单个下载任务的内存使用不得超过 100MB
- [ ] **响应时间**: 下载进度和速度信息的更新延迟不得超过 1 秒

### 安全需求

- [ ] **API 密钥保护**: 快速下载 API 密钥必须安全存储，不得泄露
- [ ] **输入验证**: 所有下载 URL 必须进行验证和清理
- [ ] **文件验证**: 下载完成后必须验证文件完整性（MD5 校验）
- [ ] **错误处理**: 所有下载错误必须妥善处理，不得泄露敏感信息

### 可用性需求

- [ ] **错误提示**: 下载失败时必须提供友好的错误提示
- [ ] **状态显示**: 必须清晰显示下载状态（进行中、成功、失败）
- [ ] **进度反馈**: 必须提供实时的下载进度和速度反馈
- [ ] **重试提示**: 重试时必须显示重试次数和剩余重试次数

### 可维护性需求

- [ ] **代码质量**: Python 代码必须遵循 PEP 8 规范
- [ ] **类型安全**: Python 代码必须使用类型注解
- [ ] **代码文档**: 所有公共 API 必须包含 docstring
- [ ] **测试覆盖**: 核心业务逻辑的测试覆盖率必须达到 90% 以上

---

## 技术规范

### 后端技术

**技术栈**:
- Python 3.11+
- requests 2.32.3
- BeautifulSoup4 4.12.3
- PyYAML 6.0.2

**下载引擎设计**:
- 使用 requests 库进行 HTTP 下载
- 支持流式下载，避免内存溢出
- 支持断点续传（Range 请求）
- 支持超时配置
- 支持代理配置（FlareSolverr）

**数据模型**:
```python
@dataclass
class DownloadTask:
    task_id: str
    url: str
    md5: str
    subdirectory: str
    priority: int
    status: str  # pending, downloading, completed, failed
    progress: float  # 0-100
    downloaded_bytes: int
    total_bytes: int
    speed: float  # bytes/s
    retry_count: int
    source: str  # fast, mirror1, mirror2, etc.
    error_message: str
    created_at: datetime
    updated_at: datetime
```

**业务逻辑**:
- 下载任务调度器：从队列中获取任务并执行下载
- 下载引擎：实际执行下载操作
- 回退管理器：管理下载源的回退逻辑
- 进度跟踪器：跟踪下载进度和速度
- 重试管理器：管理重试逻辑

---

### 前端技术

**技术栈**:
- HTML5
- SCSS（使用 Dracula 主题）
- JavaScript (ES6+)
- Remix Icon

**组件设计**:
- 下载进度条组件：显示下载进度百分比
- 下载速度显示组件：显示当前下载速度
- 下载状态指示器组件：显示下载状态图标
- 下载源指示器组件：显示当前使用的下载源

**状态管理**:
- 使用 JavaScript 对象存储下载状态
- 使用定时器定期更新下载状态（每 2 秒）
- 使用 WebSocket 或轮询获取实时进度

**交互设计**:
- 下载进度条实时更新
- 下载速度实时显示
- 下载状态变化时显示通知
- 下载源切换时显示提示

---

### 数据库设计

**数据模型**:
- 下载任务表：存储所有下载任务信息
- 下载历史表：存储下载历史记录
- 下载源配置表：存储下载源配置信息

**索引策略**:
- task_id：主键索引
- md5：唯一索引，用于去重
- status：普通索引，用于状态查询
- created_at：普通索引，用于时间范围查询

**查询优化**:
- 使用索引加速状态查询
- 使用分页查询历史记录
- 使用缓存存储活跃任务状态

---

## 接口规范

### API 端点 1: 获取下载进度

**方法**: GET

**路径**: `/api/v1/download/progress/{task_id}`

**描述**: 获取指定任务的下载进度信息

**请求参数**:
| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| task_id | string | 是 | 任务 ID |

**响应格式**:
```json
{
  "success": true,
  "data": {
    "task_id": "abc123",
    "status": "downloading",
    "progress": 45.5,
    "downloaded_bytes": 45500000,
    "total_bytes": 100000000,
    "speed": 2500000,
    "source": "fast",
    "retry_count": 0,
    "error_message": ""
  },
  "message": "获取成功"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": {
    "code": "TASK_NOT_FOUND",
    "message": "任务不存在"
  }
}
```

**认证要求**: 需要 Admin 或 Downloader API Key

**速率限制**: 10 请求/秒

---

### API 端点 2: 获取下载速度

**方法**: GET

**路径**: `/api/v1/download/speed/{task_id}`

**描述**: 获取指定任务的下载速度信息

**请求参数**:
| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| task_id | string | 是 | 任务 ID |

**响应格式**:
```json
{
  "success": true,
  "data": {
    "task_id": "abc123",
    "current_speed": 2500000,
    "average_speed": 2300000,
    "peak_speed": 3000000,
    "speed_unit": "MB/s"
  },
  "message": "获取成功"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": {
    "code": "TASK_NOT_FOUND",
    "message": "任务不存在"
  }
}
```

**认证要求**: 需要 Admin 或 Downloader API Key

**速率限制**: 10 请求/秒

---

### API 端点 3: 配置下载源

**方法**: POST

**路径**: `/api/v1/download/sources/configure`

**描述**: 配置下载源信息

**请求参数**:
```json
{
  "sources": [
    {
      "name": "fast",
      "type": "api",
      "url": "https://api.annas-archive.org/fast",
      "api_key": "your_api_key",
      "priority": 1,
      "enabled": true
    },
    {
      "name": "mirror1",
      "type": "mirror",
      "url": "https://mirror1.annas-archive.org",
      "priority": 2,
      "enabled": true
    }
  ]
}
```

**响应格式**:
```json
{
  "success": true,
  "data": {
    "message": "下载源配置成功"
  },
  "message": "配置成功"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": {
    "code": "INVALID_CONFIG",
    "message": "配置无效"
  }
}
```

**认证要求**: 需要 Admin API Key

**速率限制**: 5 请求/秒

---

## 用户界面设计

### 页面 1: 下载监控页面

**描述**: 显示当前下载任务的进度和速度信息

**布局**:
- 顶部：下载任务列表
- 中部：当前下载任务详情
- 底部：下载历史记录

**组件**:
- 下载进度条：显示下载进度百分比
- 下载速度显示：显示当前下载速度
- 下载状态指示器：显示下载状态图标
- 下载源指示器：显示当前使用的下载源
- 重试次数显示：显示当前重试次数

**交互流程**:
1. 页面加载时获取当前下载任务列表
2. 每 2 秒更新一次下载进度和速度
3. 下载状态变化时显示通知
4. 下载源切换时显示提示

**响应式断点**:
- 桌面: > 1024px
- 平板: 768px - 1024px
- 移动: < 768px

---

### 页面 2: 下载源配置页面

**描述**: 配置和管理下载源

**布局**:
- 顶部：下载源列表
- 中部：添加/编辑下载源表单
- 底部：下载源测试按钮

**组件**:
- 下载源列表：显示所有配置的下载源
- 下载源表单：添加或编辑下载源
- 下载源测试按钮：测试下载源可用性
- 下载源启用/禁用开关：控制下载源状态

**交互流程**:
1. 页面加载时获取下载源列表
2. 用户添加或编辑下载源
3. 用户测试下载源可用性
4. 用户启用或禁用下载源

**响应式断点**:
- 桌面: > 1024px
- 平板: 768px - 1024px
- 移动: < 768px

---

## 测试规范

### 单元测试

**测试框架**: pytest

**覆盖率要求**:
- 核心业务逻辑: ≥ 90%
- 整体代码库: ≥ 80%

**测试命名**:
- 使用 `test_<function_name>` 格式
- 使用 Given-When-Then 模式

**示例**:
```python
def test_download_success():
    # Given: 一个有效的下载任务
    task = create_download_task(url="http://example.com/file.pdf")
    
    # When: 执行下载
    result = downloader.download(task)
    
    # Then: 下载应该成功
    assert result.success is True
    assert result.file_path is not None
    assert result.progress == 100.0
```

---

### 集成测试

**测试范围**:
- 下载引擎与队列管理器的交互
- 下载引擎与配置管理器的交互
- 下载引擎与回退管理器的交互

**测试要求**:
- 使用 mock 隔离外部依赖
- 测试所有关键路径
- 验证错误处理

---

### 端到端测试

**测试场景**:
- 从队列中获取任务并下载
- 快速下载失败后回退到镜像站点
- 下载中断后恢复下载
- 下载失败后重试

**测试要求**:
- 测试完整的下载工作流
- 验证 UI 交互
- 验证数据一致性

---

### 性能测试

**测试指标**:
- 下载速度 ≥ 10MB/s（取决于网络条件）
- 进度更新延迟 < 1 秒
- 支持 5+ 并发下载任务

**测试工具**:
- pytest-benchmark
- Locust

---

## 部署规范

### 环境配置

**开发环境**:
- Python 3.11+
- 虚拟环境：.venv
- 配置文件：config.yaml

**测试环境**:
- Python 3.11+
- 虚拟环境：.venv
- 配置文件：config.test.yaml

**生产环境**:
- Python 3.11+
- Docker 容器
- 配置文件：/app/config/config.yaml

---

### Docker 配置

**Dockerfile**:
```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["python", "app.py"]
```

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  stacks:
    build: .
    ports:
      - "8080:8080"
    volumes:
      - ./config:/app/config
      - ./downloads:/app/downloads
      - ./logs:/app/logs
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
```

---

### CI/CD 流程

**持续集成**:
- 代码提交后自动运行测试
- 代码质量检查（black, flake8, mypy）
- 构建和部署到测试环境

**持续部署**:
- 测试通过后自动部署到生产环境
- 部署前必须通过所有检查
- 部署后必须验证服务健康

---

## 文档要求

### 代码文档

- 所有公共 API 必须包含 docstring（遵循 Google 风格）
- 复杂逻辑必须包含内联注释
- 所有配置项必须包含说明注释

### API 文档

- 使用 OpenAPI/Swagger 格式
- 包含所有端点的详细说明
- 包含请求和响应示例

### 用户文档

- 快速开始指南
- 下载源配置说明
- 故障排除指南

### 开发文档

- 下载引擎架构设计文档
- 开发环境搭建指南
- 贡献指南

---

## 风险与依赖

### 技术风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 快速下载 API 不可用 | 中 | 高 | 实现自动回退到镜像站点 |
| 镜像站点不可用 | 中 | 中 | 配置多个镜像站点 |
| 下载速度慢 | 低 | 中 | 优化下载引擎性能 |
| 下载中断 | 中 | 中 | 实现断点续传 |
| 文件损坏 | 低 | 高 | 实现 MD5 校验 |

---

### 外部依赖

- requests 2.32.3: HTTP 请求库
- BeautifulSoup4 4.12.3: HTML 解析库
- PyYAML 6.0.2: YAML 配置文件解析库

---

## 验收标准

### 功能验收

- [ ] 所有功能需求已实现
- [ ] 所有功能测试通过
- [ ] 所有用户场景验证通过

### 非功能验收

- [ ] 性能指标达标
- [ ] 安全测试通过
- [ ] 可用性测试通过
- [ ] 兼容性测试通过

### 文档验收

- [ ] 代码文档完整
- [ ] API 文档完整
- [ ] 部署文档完整
- [ ] 用户文档完整

---

## 附录

### 参考资料

- Anna's Archive API 文档
- Python requests 库文档
- pytest 测试框架文档

### 相关文档

- [实施计划](plan.md)
- [任务列表](tasks.md)
- [项目宪法](../memory/constitution.md)

### 术语表

| 术语 | 定义 |
|------|------|
| 快速下载 API | Anna's Archive 提供的高速下载 API，需要会员权限 |
| 镜像站点 | Anna's Archive 的镜像网站，提供相同的下载内容 |
| 回退机制 | 当当前下载源失败时自动切换到备用下载源的机制 |
| 断点续传 | 从上次中断的位置继续下载的功能 |
| 重试机制 | 下载失败后自动重新尝试下载的功能 |

---

**本规范必须与项目宪法保持一致，任何偏离必须经过审查和批准。**
