# 用户认证与授权系统功能规范

## 项目信息

- **项目名称**: Stacks - Anna's Archive 下载管理器
- **规范版本**: 1.0.0
- **创建日期**: 2025-12-25
- **最后更新**: 2025-12-25
- **负责人**: 待定

---

## 宪法合规性检查

本功能规范必须遵循以下宪法原则：

- [x] **代码质量标准**: 明确代码风格、类型注解、错误处理要求
- [x] **测试标准**: 定义测试类型、覆盖率要求、测试命名规范
- [x] **用户体验一致性**: 明确界面风格、响应式设计、交互反馈要求
- [x] **性能要求**: 定义响应时间、并发处理、资源使用标准
- [x] **安全与隐私**: 明确认证授权、数据保护、输入验证要求
- [x] **文档与可维护性**: 定义文档类型、版本控制、依赖管理要求

---

## 功能概述

### 背景

Stacks 下载管理器需要提供安全的用户认证与授权机制，以保护系统免受未授权访问。系统需要支持多种认证方式，包括基于会话的 Web 界面认证、Admin API Key 认证和 Downloader API Key 认证，以满足不同使用场景的安全需求。

### 目标

提供多层次、灵活且安全的认证授权系统，确保：
1. 用户可以通过安全的 Web 界面登录访问系统
2. 第三方应用可以通过 API Key 集成系统功能
3. 支持不同权限级别的访问控制
4. 所有敏感信息（密码、密钥）都经过加密存储
5. 提供便捷的密钥管理和密码重置功能

### 范围

本规范涵盖以下功能：
- Web 界面登录认证（基于会话）
- Admin API Key 认证（完全访问权限）
- Downloader API Key 认证（受限访问权限）
- 密码哈希与验证（使用 bcrypt）
- 会话管理与超时控制
- API 密钥生成、禁用与重新生成
- 密码重置机制

### 预期成果

- 用户能够安全登录 Web 界面
- 第三方应用能够通过 API Key 访问系统
- 系统能够区分不同权限级别的用户
- 所有认证信息都经过安全加密
- 用户能够方便地管理自己的密钥和密码

---

## 功能需求

### 功能需求 1: Web 界面登录认证

**描述**: 用户可以通过用户名和密码登录 Web 界面，系统验证凭据后创建会话。

**用户故事**: 作为系统管理员，我想要通过用户名和密码登录 Web 界面，以便安全地访问和管理下载任务。

**验收标准**:
- [ ] 用户可以通过登录页面输入用户名和密码
- [ ] 系统使用 bcrypt 验证密码哈希
- [ ] 验证成功后创建用户会话
- [ ] 会话使用 HTTPOnly 和 Secure Cookie
- [ ] 登录失败时显示友好的错误提示
- [ ] 支持禁用登录功能（通过配置）

**优先级**: 高

**依赖项**: 无

---

### 功能需求 2: Admin API Key 认证

**描述**: Admin API Key 提供对系统所有功能的完全访问权限，适用于个人使用和完全控制场景。

**用户故事**: 作为高级用户，我想要使用 Admin API Key 访问所有 API 端点，以便通过脚本自动化管理下载任务。

**验收标准**:
- [ ] Admin API Key 可以访问所有 API 端点
- [ ] API Key 通过 HTTP 请求头传递（X-API-Key）
- [ ] 系统验证 API Key 的有效性
- [ ] 无效的 API Key 返回 401 未授权错误
- [ ] Admin API Key 可以生成、重新生成和禁用
- [ ] 禁用的 API Key 无法访问任何端点

**优先级**: 高

**依赖项**: 无

---

### 功能需求 3: Downloader API Key 认证

**描述**: Downloader API Key 提供受限访问权限，仅允许添加到队列和列出子目录，适用于与 Tampermonkey 扩展集成。

**用户故事**: 作为普通用户，我想要使用 Downloader API Key 添加下载任务，以便通过浏览器扩展安全地使用系统。

**验收标准**:
- [ ] Downloader API Key 仅能访问特定端点（/api/queue/add, /api/subdirs）
- [ ] Downloader API Key 无法访问管理端点（配置、历史、队列管理）
- [ ] API Key 通过 HTTP 请求头传递（X-API-Key）
- [ ] 系统验证 API Key 的有效性和类型
- [ ] 无效的 API Key 返回 401 未授权错误
- [ ] 权限不足的 API Key 返回 403 禁止访问错误
- [ ] Downloader API Key 可以生成、重新生成和禁用

**优先级**: 高

**依赖项**: 无

---

### 功能需求 4: 密码哈希与验证

**描述**: 所有用户密码必须使用 bcrypt 算法加盐哈希存储，确保即使数据库泄露也无法还原明文密码。

**用户故事**: 作为系统管理员，我想要确保我的密码安全存储，以便即使系统被攻击也不会泄露我的密码。

**验收标准**:
- [ ] 密码使用 bcrypt 算法哈希存储
- [ ] 每个密码使用唯一的盐值
- [ ] 哈希强度至少为 12 轮
- [ ] 密码验证使用相同的哈希算法
- [ ] 明文密码不在日志中记录
- [ ] 密码长度至少为 6 个字符
- [ ] 密码可以包含特殊字符

**优先级**: 高

**依赖项**: 无

---

### 功能需求 5: 会话管理与超时控制

**描述**: 系统管理用户会话，包括会话创建、验证、过期和销毁。

**用户故事**: 作为系统管理员，我想要系统自动管理我的会话，以便长时间不活动时自动登出保护安全。

**验收标准**:
- [ ] 登录成功后创建唯一会话标识
- [ ] 会话标识存储在 HTTPOnly Cookie 中
- [ ] 会话具有过期时间（默认 24 小时）
- [ ] 过期的会话自动失效
- [ ] 用户可以手动登出销毁会话
- [ ] 会话密钥使用强随机数生成
- [ ] 支持配置会话过期时间

**优先级**: 高

**依赖项**: 功能需求 1

---

### 功能需求 6: API 密钥管理

**描述**: 系统提供 API 密钥的生成、查看、重新生成和禁用功能。

**用户故事**: 作为系统管理员，我想要管理 API 密钥，以便控制第三方应用的访问权限。

**验收标准**:
- [ ] Admin API Key 可以在设置界面查看
- [ ] Downloader API Key 可以在设置界面查看
- [ ] Admin API Key 可以重新生成（旧密钥立即失效）
- [ ] Downloader API Key 可以重新生成（旧密钥立即失效）
- [ ] Admin API Key 可以禁用（设置为 null）
- [ ] Downloader API Key 可以禁用（设置为 null）
- [ ] API 密钥使用强随机字符串生成（至少 32 字符）
- [ ] API 密钥安全存储（哈希或加密）

**优先级**: 高

**依赖项**: 功能需求 2, 功能需求 3

---

### 功能需求 7: 密码重置机制

**描述**: 用户可以通过环境变量重置管理员密码，适用于忘记密码的场景。

**用户故事**: 作为系统管理员，我想要重置忘记的密码，以便重新访问系统。

**验收标准**:
- [ ] 通过设置 RESET_ADMIN=true 环境变量启用密码重置
- [ ] 通过设置 PASSWORD 环境变量指定新密码
- [ ] 密码重置仅在容器启动时生效
- [ ] 重置后密码立即生效
- [ ] 重置后可以正常登录
- [ ] 建议在重置后移除 RESET_ADMIN 环境变量

**优先级**: 中

**依赖项**: 功能需求 1, 功能需求 4

---

## 非功能需求

### 性能需求

- [ ] **响应时间**: 登录验证响应时间必须在 500ms 以内（P95）
- [ ] **并发处理**: 系统必须支持至少 50 个并发认证请求
- [ ] **资源使用**: 单个会话的内存使用不得超过 10KB
- [ ] **缓存策略**: API 密钥验证结果必须缓存（TTL 5 分钟）

### 安全需求

- [ ] **认证**: 所有密码必须使用 bcrypt 加盐哈希（至少 12 轮）
- [ ] **授权**: 必须实现基于密钥类型的访问控制
- [ ] **会话管理**: 必须使用 HTTPOnly 和 Secure 标志设置 Cookie
- [ ] **输入验证**: 所有用户输入必须进行验证和清理（防止 SQL 注入、XSS）
- [ ] **数据保护**: 所有敏感数据（密码、密钥）必须加密存储

### 可用性需求

- [ ] **界面一致性**: 登录界面必须使用统一的 Dracula 主题配色
- [ ] **响应式设计**: 登录界面必须在桌面、平板和移动设备上正常显示
- [ ] **交互反馈**: 所有异步操作必须提供加载指示器
- [ ] **可访问性**: 颜色对比度必须符合 WCAG AA 标准
- [ ] **错误提示**: 错误信息必须清晰易懂，不泄露敏感信息

### 可维护性需求

- [ ] **代码质量**: Python 代码必须遵循 PEP 8 规范
- [ ] **类型安全**: Python 代码必须使用类型注解
- [ ] **代码文档**: 所有公共 API 必须包含 docstring
- [ ] **测试覆盖**: 认证授权逻辑的测试覆盖率必须达到 95% 以上

---

## 技术规范

### 后端技术

**技术栈**:
- Python 3.11+
- Flask 3.1.2
- bcrypt
- Flask-Session（会话管理）
- PyYAML（配置管理）

**API 设计**:
- RESTful API 设计
- 统一的错误响应格式
- 适当的 HTTP 状态码（200, 401, 403, 500）

**数据模型**:
```yaml
# 用户配置模型
login:
  username: string
  password: string (bcrypt 哈希)
  disable: boolean

# API 配置模型
api:
  key: string (Admin API Key)
  session_secret: string (会话密钥)
  downloader_key: string (Downloader API Key)
```

**业务逻辑**:
1. 登录验证流程：接收用户名密码 → 验证哈希 → 创建会话 → 返回成功
2. API Key 验证流程：接收 API Key → 查找密钥类型 → 验证权限 → 返回结果
3. 密码重置流程：检查环境变量 → 生成新哈希 → 更新配置 → 返回成功

---

### 前端技术

**技术栈**:
- HTML5
- SCSS（使用 Dracula 主题）
- JavaScript (ES6+)
- Remix Icon

**组件设计**:
- 登录表单组件（用户名、密码输入框，登录按钮）
- API 密钥管理组件（显示、重新生成、禁用按钮）
- 密码修改组件（当前密码、新密码、确认密码）

**状态管理**:
- 使用本地存储保存会话状态
- 使用 JavaScript 管理表单状态

**交互设计**:
- 登录表单提交时显示加载指示器
- 登录失败时显示错误提示（不泄露具体错误）
- API 密钥操作前显示确认对话框

---

### 数据库设计

**数据模型**:
系统使用 YAML 配置文件存储认证信息，不使用传统数据库。

**配置文件结构**:
```yaml
# config.yaml
login:
  username: "admin"
  password: "$2b$12$..." (bcrypt 哈希)
  disable: false

api:
  key: "abc123..." (Admin API Key)
  session_secret: "xyz789..." (会话密钥)
```

**索引策略**:
不适用（基于文件存储）

**查询优化**:
不适用（基于文件存储）

---

## 接口规范

### API 端点 1: 用户登录

**方法**: POST

**路径**: `/api/login`

**描述**: 用户通过用户名和密码登录系统

**请求参数**:
| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |

**响应格式**:
```json
{
  "success": true,
  "message": "登录成功"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "用户名或密码错误"
  }
}
```

**认证要求**: 无

**速率限制**: 5 次/分钟

---

### API 端点 2: 获取 API 密钥

**方法**: GET

**路径**: `/api/key`

**描述**: 获取当前用户的 API 密钥信息

**请求参数**: 无

**响应格式**:
```json
{
  "success": true,
  "data": {
    "admin_key": "abc123...",
    "downloader_key": "xyz789..."
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "未授权访问"
  }
}
```

**认证要求**: 会话认证（仅 Web UI）

**速率限制**: 10 次/分钟

---

### API 端点 3: 重新生成 Admin API Key

**方法**: POST

**路径**: `/api/key/regenerate`

**描述**: 重新生成 Admin API Key（旧密钥立即失效）

**请求参数**: 无

**响应格式**:
```json
{
  "success": true,
  "data": {
    "admin_key": "new_key_abc123..."
  },
  "message": "API 密钥已重新生成"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "未授权访问"
  }
}
```

**认证要求**: 会话认证（仅 Web UI）

**速率限制**: 1 次/分钟

---

### API 端点 4: 禁用 Admin API Key

**方法**: POST

**路径**: `/api/key/disable`

**描述**: 禁用 Admin API Key

**请求参数**: 无

**响应格式**:
```json
{
  "success": true,
  "message": "API 密钥已禁用"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "未授权访问"
  }
}
```

**认证要求**: 会话认证（仅 Web UI）

**速率限制**: 5 次/分钟

---

### API 端点 5: 重新生成 Downloader API Key

**方法**: POST

**路径**: `/api/key/downloader/regenerate`

**描述**: 重新生成 Downloader API Key（旧密钥立即失效）

**请求参数**: 无

**响应格式**:
```json
{
  "success": true,
  "data": {
    "downloader_key": "new_key_xyz789..."
  },
  "message": "API 密钥已重新生成"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "未授权访问"
  }
}
```

**认证要求**: 会话认证（仅 Web UI）

**速率限制**: 1 次/分钟

---

### API 端点 6: 禁用 Downloader API Key

**方法**: POST

**路径**: `/api/key/downloader/disable`

**描述**: 禁用 Downloader API Key

**请求参数**: 无

**响应格式**:
```json
{
  "success": true,
  "message": "API 密钥已禁用"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "未授权访问"
  }
}
```

**认证要求**: 会话认证（仅 Web UI）

**速率限制**: 5 次/分钟

---

### API 端点 7: 测试 API Key

**方法**: POST

**路径**: `/api/key/test`

**描述**: 测试 API Key 的有效性和类型

**请求参数**:
| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| key | string | 是 | API 密钥 |

**响应格式**:
```json
{
  "valid": true,
  "type": "admin"
}
```

或

```json
{
  "valid": true,
  "type": "downloader"
}
```

**错误响应**:
```json
{
  "valid": false,
  "error": "无效的 API 密钥"
}
```

**认证要求**: 无

**速率限制**: 20 次/分钟

---

## 用户界面设计

### 页面 1: 登录页面

**描述**: 用户登录界面，提供用户名和密码输入框

**布局**:
- 居中登录表单
- Logo 和标题
- 用户名输入框
- 密码输入框
- 登录按钮
- 错误提示区域

**组件**:
- 登录表单: 包含用户名、密码输入框和登录按钮
- Logo: Stacks 项目 Logo
- 错误提示: 显示登录失败的错误信息

**交互流程**:
1. 用户输入用户名和密码
2. 点击登录按钮
3. 显示加载指示器
4. 验证成功后跳转到主界面
5. 验证失败显示错误提示

**响应式断点**:
- 桌面: > 1024px
- 平板: 768px - 1024px
- 移动: < 768px

---

### 页面 2: 设置页面 - 认证部分

**描述**: 设置页面中的认证配置部分，提供密码修改和 API 密钥管理功能

**布局**:
- 分组配置区域
- 登录凭据配置（用户名、密码修改）
- API 密钥配置（Admin Key、Downloader Key）
- 保存按钮

**组件**:
- 密码修改表单: 当前密码、新密码、确认密码
- API 密钥显示: Admin Key 和 Downloader Key 显示区域
- API 密钥操作: 重新生成、禁用按钮
- 保存按钮: 保存配置更改

**交互流程**:
1. 用户查看当前 API 密钥
2. 点击重新生成按钮显示确认对话框
3. 确认后生成新密钥并显示
4. 用户修改密码后点击保存
5. 显示保存成功提示

**响应式断点**:
- 桌面: > 1024px
- 平板: 768px - 1024px
- 移动: < 768px

---

## 测试规范

### 单元测试

**测试框架**: pytest

**覆盖率要求**:
- 认证授权逻辑: ≥ 95%
- 整体代码库: ≥ 80%

**测试命名**:
- 使用 `test_<function_name>` 格式
- 使用 Given-When-Then 模式

**示例**:
```python
def test_login_success():
    # Given: 一个有效的用户凭据
    username = "admin"
    password = "correct_password"
    
    # When: 执行登录
    result = auth.login(username, password)
    
    # Then: 登录应该成功
    assert result.success is True
    assert result.session_id is not None
```

---

### 集成测试

**测试范围**:
- 认证模块与配置模块的交互
- API 端点集成
- 会话管理集成

**测试要求**:
- 使用 mock 隔离外部依赖
- 测试所有关键路径
- 验证错误处理

---

### 端到端测试

**测试场景**:
- 用户登录成功流程
- 用户登录失败流程
- API Key 生成和使用流程
- 密码修改流程
- API Key 禁用流程

**测试要求**:
- 测试完整的用户工作流
- 验证 UI 交互
- 验证数据一致性

---

### 性能测试

**测试指标**:
- 登录验证响应时间 < 500ms（P95）
- API Key 验证响应时间 < 200ms（P95）
- 支持 50+ 并发认证请求

**测试工具**:
- Locust
- pytest-benchmark

---

## 部署规范

### 环境配置

**开发环境**:
- 使用 Flask 开发服务器
- 启用调试模式
- 使用临时配置文件

**测试环境**:
- 使用 Gunicorn 生产服务器
- 禁用调试模式
- 使用测试配置文件

**生产环境**:
- 使用 Gunicorn 生产服务器
- 禁用调试模式
- 使用持久化配置文件

---

### Docker 配置

**Dockerfile**:
使用项目现有的 Dockerfile

**docker-compose.yml**:
```yaml
environment:
  - USERNAME=admin
  - PASSWORD=stacks
  - RESET_ADMIN=false
```

---

### CI/CD 流程

**持续集成**:
- 代码提交后自动运行测试
- 代码质量检查（black, flake8, mypy）
- 构建和部署到测试环境

**持续部署**:
- 测试通过后自动部署到生产环境
- 部署前必须通过所有检查
- 部署后必须验证服务健康

---

## 文档要求

### 代码文档

- 所有公共 API 必须包含 docstring（遵循 Google 风格）
- 复杂逻辑必须包含内联注释
- 所有配置项必须包含说明注释

### API 文档

- 使用 OpenAPI/Swagger 格式
- 包含所有端点的详细说明
- 包含请求和响应示例

### 用户文档

- 快速开始指南（包含登录说明）
- API 密钥管理指南
- 密码重置指南

### 开发文档

- 认证授权架构设计文档
- 开发环境搭建指南
- 贡献指南

---

## 风险与依赖

### 技术风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| bcrypt 算法性能问题 | 低 | 中 | 使用合理的哈希轮数（12 轮） |
| 会话劫持 | 低 | 高 | 使用 HTTPOnly 和 Secure Cookie |
| API 密钥泄露 | 中 | 高 | 提供密钥禁用和重新生成功能 |
| 密码暴力破解 | 中 | 中 | 实施速率限制和账户锁定 |

---

### 外部依赖

- bcrypt: 用于密码哈希
- Flask-Session: 用于会话管理
- PyYAML: 用于配置管理

---

## 验收标准

### 功能验收

- [ ] 所有功能需求已实现
- [ ] 所有功能测试通过
- [ ] 所有用户场景验证通过

### 非功能验收

- [ ] 性能指标达标
- [ ] 安全测试通过
- [ ] 可用性测试通过
- [ ] 兼容性测试通过

### 文档验收

- [ ] 代码文档完整
- [ ] API 文档完整
- [ ] 部署文档完整
- [ ] 用户文档完整

---

## 附录

### 参考资料

- Flask 文档: https://flask.palletsprojects.com/
- bcrypt 文档: https://pypi.org/project/bcrypt/
- OWASP 认证备忘单: https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html

### 相关文档

- [实施计划](plan.md)
- [任务列表](tasks.md)
- [项目宪法](../memory/constitution.md)

### 术语表

| 术语 | 定义 |
|------|------|
| bcrypt | 一种密码哈希函数，使用盐值和可配置的计算成本 |
| HTTPOnly Cookie | 一种 Cookie 属性，防止客户端脚本访问 Cookie |
| Secure Cookie | 一种 Cookie 属性，仅通过 HTTPS 传输 |
| API Key | 用于身份验证的密钥字符串 |
| 会话 | 用户登录后创建的临时状态，用于跟踪用户身份 |

---

**本规范必须与项目宪法保持一致，任何偏离必须经过审查和批准。**
