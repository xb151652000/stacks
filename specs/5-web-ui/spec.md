# 功能规范：Web界面与实时监控系统

## 项目信息

- **项目名称**: Stacks - Anna's Archive 下载管理器
- **规范版本**: 1.0.0
- **创建日期**: 2025-12-25
- **最后更新**: 2025-12-25
- **负责人**: 开发团队

---

## 宪法合规性检查

本功能规范必须遵循以下宪法原则：

- [x] **代码质量标准**: 明确代码风格、类型注解、错误处理要求
- [x] **测试标准**: 定义测试类型、覆盖率要求、测试命名规范
- [x] **用户体验一致性**: 明确界面风格、响应式设计、交互反馈要求
- [x] **性能要求**: 定义响应时间、并发处理、资源使用标准
- [x] **安全与隐私**: 明确认证授权、数据保护、输入验证要求
- [x] **文档与可维护性**: 定义文档类型、版本控制、依赖管理要求

---

## 功能概述

### 背景

Stacks 项目需要一个美观、响应式的 Web 界面，用于监控和管理下载任务。用户需要能够实时查看下载进度、速度、队列状态等信息，并进行各种管理操作。界面设计需要遵循 Dracula 主题，确保视觉一致性和用户体验的一致性。

### 目标

- 提供美观、响应式的 Web 界面
- 实现实时监控下载状态和进度
- 提供友好的用户交互体验
- 支持多种设备访问（桌面、平板、移动）
- 提供清晰的状态反馈和错误提示

### 范围

本规范涵盖 Web 界面与实时监控系统的所有核心功能，包括：
- 主仪表板界面（下载监控）
- 设置管理界面
- 实时进度显示
- 下载历史记录显示
- 快速下载配额显示
- 德古拉主题 UI 设计
- 响应式布局支持
- 登录界面

### 预期成果

- 一个美观、响应式的 Web 界面
- 实时更新的下载状态和进度显示
- 友好的用户交互体验
- 支持多种设备的访问
- 清晰的状态反馈和错误提示

---

## 功能需求

### 功能需求 1: 主仪表板界面

**描述**: 提供主仪表板界面，显示下载任务列表、当前下载进度、队列状态等信息。

**用户故事**: 作为系统用户，我想要在一个页面上查看所有下载任务的状态和进度，以便了解系统运行情况。

**验收标准**:
- [ ] 显示当前下载任务的详细信息
- [ ] 显示下载队列中的待下载任务
- [ ] 显示下载历史记录
- [ ] 显示快速下载配额信息
- [ ] 显示系统状态信息
- [ ] 提供任务管理操作按钮（暂停、取消、重试等）

**优先级**: 高

**依赖项**: 下载队列管理系统、下载引擎系统

---

### 功能需求 2: 设置管理界面

**描述**: 提供设置管理界面，允许用户配置系统参数。

**用户故事**: 作为系统管理员，我想要通过 Web 界面配置系统参数，以便调整系统行为。

**验收标准**:
- [ ] 提供服务器配置选项（主机、端口）
- [ ] 提供登录配置选项（用户名、密码、禁用选项）
- [ ] 提供 API 配置选项（密钥、会话密钥）
- [ ] 提供下载配置选项（延迟、重试次数、恢复尝试次数）
- [ ] 提供快速下载配置选项（启用状态、API 密钥）
- [ ] 提供 FlareSolverr 配置选项（启用状态、URL、超时）
- [ ] 提供队列配置选项（最大历史记录数）
- [ ] 提供日志配置选项（日志级别）
- [ ] 支持配置实时重载
- [ ] 支持配置验证与测试

**优先级**: 高

**依赖项**: 配置管理系统

---

### 功能需求 3: 实时进度显示

**描述**: 实现实时进度显示功能，定期更新下载进度信息。

**用户故事**: 作为系统用户，我想要实时查看下载进度，以便了解下载状态。

**验收标准**:
- [ ] 每 2 秒更新一次下载进度
- [ ] 显示当前下载任务的进度条
- [ ] 显示下载百分比
- [ ] 显示已下载字节数和总字节数
- [ ] 显示预计剩余时间
- [ ] 支持暂停和恢复进度更新

**优先级**: 高

**依赖项**: 下载引擎系统

---

### 功能需求 4: 当前下载进度条与百分比

**描述**: 显示当前下载任务的进度条和百分比。

**用户故事**: 作为系统用户，我想要直观地查看当前下载任务的进度，以便了解下载状态。

**验收标准**:
- [ ] 显示当前下载任务的进度条
- [ ] 显示下载百分比
- [ ] 进度条颜色根据进度变化
- [ ] 支持动画效果
- [ ] 支持暂停和恢复下载

**优先级**: 高

**依赖项**: 实时进度显示

---

### 功能需求 5: 队列大小与待下载任务显示

**描述**: 显示队列大小和待下载任务列表。

**用户故事**: 作为系统用户，我想要查看队列中的待下载任务，以便了解下载计划。

**验收标准**:
- [ ] 显示队列大小（待下载任务数量）
- [ ] 显示待下载任务列表
- [ ] 显示每个任务的优先级
- [ ] 显示每个任务的子目录
- [ ] 支持从队列中移除任务
- [ ] 支持清空队列

**优先级**: 高

**依赖项**: 下载队列管理系统

---

### 功能需求 6: 下载历史记录显示

**描述**: 显示下载历史记录，包括成功和失败的下载。

**用户故事**: 作为系统用户，我想要查看下载历史记录，以便了解过去的下载情况。

**验收标准**:
- [ ] 显示下载历史记录列表
- [ ] 显示下载状态（成功、失败）
- [ ] 显示下载时间
- [ ] 显示下载文件信息
- [ ] 支持重试失败的下载
- [ ] 支持清空历史记录

**优先级**: 高

**依赖项**: 下载历史与重试机制

---

### 功能需求 7: 快速下载配额显示

**描述**: 显示快速下载配额信息。

**用户故事**: 作为 Anna's Archive 会员，我想要查看快速下载配额，以便了解剩余下载次数。

**验收标准**:
- [ ] 显示快速下载配额信息
- [ ] 显示已使用配额
- [ ] 显示剩余配额
- [ ] 显示配额重置时间
- [ ] 支持刷新配额信息

**优先级**: 高

**依赖项**: 下载引擎系统

---

### 功能需求 8: 德古拉主题 UI 设计

**描述**: 使用 Dracula 主题设计 UI，确保视觉一致性。

**用户故事**: 作为系统用户，我想要使用美观一致的界面，以便获得良好的用户体验。

**验收标准**:
- [ ] 使用 Dracula 主题配色
- [ ] 所有页面使用统一的主题
- [ ] 支持主题切换（可选）
- [ ] 确保颜色对比度符合 WCAG AA 标准
- [ ] 提供一致的视觉风格

**优先级**: 高

**依赖项**: 无

---

### 功能需求 9: 响应式布局支持

**描述**: 支持响应式布局，适配不同设备。

**用户故事**: 作为系统用户，我想要在不同设备上都能正常使用界面，以便随时随地管理下载任务。

**验收标准**:
- [ ] 支持桌面设备（> 1024px）
- [ ] 支持平板设备（768px - 1024px）
- [ ] 支持移动设备（< 768px）
- [ ] 布局自动适配屏幕尺寸
- [ ] 支持触摸操作

**优先级**: 高

**依赖项**: 无

---

### 功能需求 10: 登录界面

**描述**: 提供登录界面，允许用户通过用户名和密码登录。

**用户故事**: 作为系统用户，我想要通过登录界面访问系统，以便安全地管理下载任务。

**验收标准**:
- [ ] 提供用户名和密码输入框
- [ ] 提供登录按钮
- [ ] 支持记住登录状态
- [ ] 登录失败时显示错误提示
- [ ] 登录成功后跳转到主仪表板
- [ ] 支持禁用登录功能（通过配置）

**优先级**: 高

**依赖项**: 用户认证系统

---

## 非功能需求

### 性能需求

- [ ] **页面加载时间**: 首次内容绘制时间 < 1 秒
- [ ] **实时更新延迟**: 下载进度更新延迟 < 2 秒
- [ ] **响应时间**: 用户操作响应时间 < 500ms
- [ ] **资源加载**: 静态资源加载时间 < 500ms

### 安全需求

- [ ] **输入验证**: 所有用户输入必须进行验证和清理
- [ ] **XSS 防护**: 防止跨站脚本攻击
- [ ] **CSRF 防护**: 防止跨站请求伪造
- [ ] **会话管理**: 使用 HTTPOnly 和 Secure Cookie

### 可用性需求

- [ ] **界面一致性**: 所有页面使用统一的 Dracula 主题
- [ ] **交互反馈**: 所有异步操作必须提供加载指示器
- [ ] **错误提示**: 错误信息必须友好且清晰
- [ ] **可访问性**: 颜色对比度必须符合 WCAG AA 标准

### 可维护性需求

- [ ] **代码质量**: JavaScript 代码必须遵循 ESLint 规范
- [ ] **模块化**: 使用模块化架构，便于维护和扩展
- [ ] **代码文档**: 所有公共函数必须包含注释
- [ ] **测试覆盖**: 核心业务逻辑的测试覆盖率必须达到 80% 以上

---

## 技术规范

### 后端技术

**技术栈**:
- Python 3.11+
- Flask 3.1.2
- Jinja2 3.1.4

**模板设计**:
- 使用 Jinja2 模板引擎
- 模板继承和包含
- 模板变量和过滤器
- 静态资源管理

**数据模型**:
```python
@dataclass
class DashboardData:
    current_task: Optional[DownloadTask]
    queue_size: int
    queue_tasks: List[DownloadTask]
    history: List[DownloadHistory]
    fast_download_quota: Optional[FastDownloadQuota]
    system_status: SystemStatus
```

**业务逻辑**:
- 仪表板数据聚合器：收集和聚合仪表板数据
- 实时更新管理器：管理实时更新逻辑
- 会话管理器：管理用户会话
- 错误处理器：处理和显示错误信息

---

### 前端技术

**技术栈**:
- HTML5
- SCSS（使用 Dracula 主题）
- JavaScript (ES6+)
- Remix Icon
- Clipboard.js

**组件设计**:
- 仪表板组件：显示仪表板主界面
- 下载进度条组件：显示下载进度
- 下载速度显示组件：显示下载速度
- 下载状态指示器组件：显示下载状态
- 队列列表组件：显示队列中的任务
- 历史记录组件：显示下载历史
- 设置表单组件：显示和编辑配置
- 登录表单组件：显示登录界面

**状态管理**:
- 使用 JavaScript 对象存储状态
- 使用定时器定期更新状态
- 使用事件监听器处理用户交互
- 使用本地存储存储用户偏好

**交互设计**:
- 实时更新下载进度和速度
- 用户操作时显示加载指示器
- 错误时显示友好的错误提示
- 成功操作时显示成功提示

---

### 样式设计

**Dracula 主题配色**:
```scss
$dracula-background: #282a36;
$dracula-current-line: #44475a;
$dracula-foreground: #f8f8f2;
$dracula-comment: #6272a4;
$dracula-cyan: #8be9fd;
$dracula-green: #50fa7b;
$dracula-orange: #ffb86c;
$dracula-pink: #ff79c6;
$dracula-purple: #bd93f9;
$dracula-red: #ff5555;
$dracula-yellow: #f1fa8c;
```

**响应式断点**:
```scss
$breakpoint-desktop: 1024px;
$breakpoint-tablet: 768px;
$breakpoint-mobile: 768px;
```

**布局设计**:
- 使用 Flexbox 和 Grid 布局
- 响应式设计，适配不同屏幕尺寸
- 移动优先设计策略

---

## 接口规范

### API 端点 1: 获取仪表板数据

**方法**: GET

**路径**: `/api/v1/dashboard`

**描述**: 获取仪表板数据

**请求参数**: 无

**响应格式**:
```json
{
  "success": true,
  "data": {
    "current_task": {
      "task_id": "abc123",
      "status": "downloading",
      "progress": 45.5,
      "downloaded_bytes": 45500000,
      "total_bytes": 100000000,
      "speed": 2500000,
      "source": "fast"
    },
    "queue_size": 5,
    "queue_tasks": [
      {
        "task_id": "def456",
        "md5": "1234567890abcdef",
        "subdirectory": "books",
        "priority": 1
      }
    ],
    "history": [
      {
        "task_id": "ghi789",
        "status": "completed",
        "file_name": "book.pdf",
        "created_at": "2025-12-25T10:00:00Z"
      }
    ],
    "fast_download_quota": {
      "used": 10,
      "remaining": 90,
      "reset_time": "2025-12-26T00:00:00Z"
    },
    "system_status": {
      "status": "running",
      "workers": 3,
      "active_workers": 1
    }
  },
  "message": "获取成功"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "未授权访问"
  }
}
```

**认证要求**: 需要会话认证或 API Key

**速率限制**: 10 请求/秒

---

### API 端点 2: 获取系统日志

**方法**: GET

**路径**: `/api/v1/system/logs`

**描述**: 获取系统日志

**请求参数**:
| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| lines | int | 否 | 返回的日志行数，默认 100 |

**响应格式**:
```json
{
  "success": true,
  "data": {
    "logs": [
      "2025-12-25 10:00:00 INFO Starting download task abc123",
      "2025-12-25 10:00:01 INFO Download progress: 10%"
    ]
  },
  "message": "获取成功"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "未授权访问"
  }
}
```

**认证要求**: 需要 Admin API Key

**速率限制**: 5 请求/秒

---

## 用户界面设计

### 页面 1: 登录页面

**描述**: 用户登录界面

**布局**:
- 居中登录表单
- 用户名输入框
- 密码输入框
- 登录按钮
- 错误提示区域

**组件**:
- 登录表单：包含用户名和密码输入
- 登录按钮：提交登录表单
- 错误提示：显示登录错误信息

**交互流程**:
1. 用户输入用户名和密码
2. 用户点击登录按钮
3. 系统验证凭据
4. 验证成功后跳转到仪表板
5. 验证失败时显示错误提示

**响应式断点**:
- 桌面: > 1024px
- 平板: 768px - 1024px
- 移动: < 768px

---

### 页面 2: 主仪表板页面

**描述**: 主仪表板界面，显示下载任务列表、当前下载进度、队列状态等信息

**布局**:
- 顶部：导航栏（包含用户信息和设置按钮）
- 左侧：当前下载任务详情
- 右侧：队列和下载历史
- 底部：系统状态和日志

**组件**:
- 导航栏：显示用户信息和设置按钮
- 当前下载任务卡片：显示当前下载任务的详细信息
- 下载进度条：显示下载进度
- 下载速度显示：显示下载速度
- 队列列表：显示队列中的待下载任务
- 下载历史列表：显示下载历史记录
- 快速下载配额：显示快速下载配额信息
- 系统状态：显示系统运行状态

**交互流程**:
1. 页面加载时获取仪表板数据
2. 每 2 秒更新一次仪表板数据
3. 用户可以暂停、取消、重试下载任务
4. 用户可以查看下载历史记录
5. 用户可以访问设置页面

**响应式断点**:
- 桌面: > 1024px
- 平板: 768px - 1024px
- 移动: < 768px

---

### 页面 3: 设置页面

**描述**: 系统设置页面，允许用户配置系统参数

**布局**:
- 顶部：导航栏（包含返回按钮）
- 中部：设置表单（分组显示）
- 底部：保存和取消按钮

**组件**:
- 设置表单：包含各种配置选项
- 服务器配置组：服务器相关配置
- 登录配置组：登录相关配置
- API 配置组：API 相关配置
- 下载配置组：下载相关配置
- 快速下载配置组：快速下载相关配置
- FlareSolverr 配置组：FlareSolverr 相关配置
- 队列配置组：队列相关配置
- 日志配置组：日志相关配置
- 保存按钮：保存配置更改
- 取消按钮：取消配置更改

**交互流程**:
1. 页面加载时获取当前配置
2. 用户修改配置选项
3. 用户点击保存按钮
4. 系统验证配置
5. 配置保存成功后显示成功提示
6. 配置保存失败时显示错误提示

**响应式断点**:
- 桌面: > 1024px
- 平板: 768px - 1024px
- 移动: < 768px

---

## 测试规范

### 单元测试

**测试框架**: Jest

**覆盖率要求**:
- 核心业务逻辑: ≥ 80%
- 整体代码库: ≥ 70%

**测试命名**:
- 使用 `test_<function_name>` 格式
- 使用 Given-When-Then 模式

**示例**:
```javascript
test('updateDashboardData updates dashboard data', () => {
  // Given: 模拟 API 响应
  const mockData = {
    current_task: { task_id: 'abc123', progress: 50 }
  };
  
  // When: 更新仪表板数据
  updateDashboardData(mockData);
  
  // Then: 数据应该更新
  expect(dashboardData.current_task.progress).toBe(50);
});
```

---

### 集成测试

**测试范围**:
- 前端与后端 API 的交互
- 组件之间的交互
- 状态管理的正确性

**测试要求**:
- 使用 mock 隔离外部依赖
- 测试所有关键路径
- 验证错误处理

---

### 端到端测试

**测试场景**:
- 用户登录流程
- 下载任务管理流程
- 配置修改流程
- 实时更新验证

**测试要求**:
- 测试完整的用户工作流
- 验证 UI 交互
- 验证数据一致性

---

### 性能测试

**测试指标**:
- 页面加载时间 < 1 秒
- 实时更新延迟 < 2 秒
- 用户操作响应时间 < 500ms

**测试工具**:
- Lighthouse
- WebPageTest

---

## 部署规范

### 环境配置

**开发环境**:
- Node.js 18+
- 虚拟环境：.venv
- 配置文件：config.yaml

**测试环境**:
- Node.js 18+
- 虚拟环境：.venv
- 配置文件：config.test.yaml

**生产环境**:
- Docker 容器
- 配置文件：/app/config/config.yaml

---

### 静态资源管理

**资源结构**:
```
static/
  css/
    main.css
  js/
    main.js
  images/
    logo.png
  fonts/
    remixicon.css
```

**资源优化**:
- 压缩 CSS 和 JavaScript
- 优化图片
- 使用缓存破坏策略

---

### CI/CD 流程

**持续集成**:
- 代码提交后自动运行测试
- 代码质量检查（ESLint）
- 构建和部署到测试环境

**持续部署**:
- 测试通过后自动部署到生产环境
- 部署前必须通过所有检查
- 部署后必须验证服务健康

---

## 文档要求

### 代码文档

- 所有公共函数必须包含注释
- 复杂逻辑必须包含内联注释
- 所有配置项必须包含说明注释

### UI 文档

- 包含所有页面的截图
- 包含交互流程说明
- 包含组件使用说明

### 用户文档

- 快速开始指南
- 界面使用说明
- 故障排除指南

### 开发文档

- 前端架构设计文档
- 组件开发指南
- 样式开发指南

---

## 风险与依赖

### 技术风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 实时更新延迟 | 中 | 中 | 优化更新频率和数据传输 |
| 浏览器兼容性 | 低 | 中 | 使用 polyfill 和兼容性测试 |
| 性能问题 | 中 | 中 | 优化代码和资源加载 |
| 安全漏洞 | 低 | 高 | 定期安全审计和更新 |

---

### 外部依赖

- Flask 3.1.2: Web 框架
- Jinja2 3.1.4: 模板引擎
- Remix Icon: 图标库
- Clipboard.js: 剪贴板操作库

---

## 验收标准

### 功能验收

- [ ] 所有功能需求已实现
- [ ] 所有功能测试通过
- [ ] 所有用户场景验证通过

### 非功能验收

- [ ] 性能指标达标
- [ ] 安全测试通过
- [ ] 可用性测试通过
- [ ] 兼容性测试通过

### 文档验收

- [ ] 代码文档完整
- [ ] UI 文档完整
- [ ] 部署文档完整
- [ ] 用户文档完整

---

## 附录

### 参考资料

- Dracula 主题文档
- Flask 文档
- Jinja2 文档
- Remix Icon 文档

### 相关文档

- [实施计划](plan.md)
- [任务列表](tasks.md)
- [项目宪法](../memory/constitution.md)

### 术语表

| 术语 | 定义 |
|------|------|
| Dracula 主题 | 一种流行的暗色主题配色方案 |
| 响应式设计 | 能够适配不同屏幕尺寸的设计方法 |
| 实时更新 | 数据自动更新，无需用户手动刷新 |
| 断点 | 响应式设计中用于切换布局的屏幕尺寸阈值 |

---

**本规范必须与项目宪法保持一致，任何偏离必须经过审查和批准。**
