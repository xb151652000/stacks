# 多网站爬取优化需求大纲

## 项目概述

将当前仅支持 Anna's Archive 的下载管理系统重构为支持多个网站的通用爬取平台，通过插件化架构实现可扩展、可维护的多网站支持。

---

## 第一阶段：基础架构搭建

- [ ] 创建抽象基类 `BaseSiteScraper`
  - 定义所有网站爬虫必须实现的接口
  - 包含 `site_name`、`site_id` 属性
  - 实现 `can_handle()` 方法用于判断是否能处理给定 URL
  - 实现 `get_download_links()` 方法获取下载链接
  - 实现 `parse_download_link_from_html()` 方法解析 HTML

- [ ] 创建站点注册表 `SiteRegistry`
  - 实现动态加载站点模块功能
  - 实现 `get_scraper()` 方法根据站点 ID 获取爬虫
  - 实现 `find_scraper()` 方法根据 URL 查找合适的爬虫
  - 实现 `list_sites()` 方法列出所有支持的站点

- [ ] 创建站点模块目录结构
  - 创建 `src/stacks/downloader/sites/` 目录
  - 创建 `sites/__init__.py` 注册表文件
  - 创建 `sites/base.py` 抽象基类文件
  - 创建 `sites/annas_archive.py` Anna's Archive 实现

- [ ] 定义统一数据模型
  - 标准化下载链接格式
  - 包含 URL、站点 ID、站点名称、类型、域名、优先级等字段
  - 确保所有网站返回相同的数据结构

---

## 第二阶段：代码重构

- [ ] 重构 `AnnaDownloader` 为 `MultiSiteDownloader`
  - 移除硬编码的 Anna's Archive URL
  - 集成站点注册表
  - 修改 `download()` 方法支持多站点输入
  - 修改 `get_download_links()` 方法使用站点爬虫

- [ ] 重构 HTML 解析逻辑
  - 将 `html.py` 中的解析逻辑移至各站点模块
  - 更新 `parse_download_link_from_html()` 使用站点特定解析器
  - 保持向后兼容性

- [ ] 重构下载编排器
  - 更新 `orchestrator.py` 支持多站点
  - 修改下载策略选择逻辑
  - 保持现有的快速下载和镜像下载功能

- [ ] 重构镜像下载模块
  - 更新 `mirrors.py` 支持多站点镜像
  - 修改镜像链接获取逻辑
  - 保持现有的 FlareSolverr 集成

---

## 第三阶段：配置系统升级

- [ ] 更新配置文件结构
  - 添加 `sites.enabled` 配置项
  - 为每个网站添加独立配置块
  - 包含网站名称、基础 URL、域名列表等

- [ ] 更新配置验证模式
  - 添加站点配置验证规则
  - 确保必需配置项存在
  - 提供合理的默认值

- [ ] 更新配置管理模块
  - 修改 `config.py` 支持多站点配置
  - 添加站点启用/禁用功能
  - 添加站点优先级配置

---

## 第四阶段：新网站支持

- [ ] 实现 Z-Library 独立爬虫
  - 将现有 `zlib.py` 重构为独立站点模块
  - 实现完整的 `BaseSiteScraper` 接口
  - 支持所有 Z-Library 域名

- [ ] 实现 Library Genesis 爬虫
  - 创建 `libgen.py` 模块
  - 实现 `BaseSiteScraper` 接口
  - 支持 LibGen 的多种域名

- [ ] 添加站点测试用例
  - 为每个站点创建测试文件
  - 测试 URL 识别功能
  - 测试下载链接获取功能
  - 测试 HTML 解析功能

---

## 第五阶段：前端界面更新

- [ ] 更新主界面
  - 添加站点选择下拉菜单
  - 显示当前支持的站点列表
  - 更新下载表单支持站点选择

- [ ] 更新 JavaScript 应用
  - 修改 `app.js` 支持多站点 API
  - 添加站点切换逻辑
  - 更新下载队列显示逻辑

- [ ] 更新设置界面
  - 添加站点配置管理界面
  - 支持启用/禁用站点
  - 支持设置站点优先级

- [ ] 更新 API 接口
  - 添加获取站点列表的 API
  - 添加站点配置的 API
  - 更新下载 API 支持站点参数

---

## 第六阶段：测试和优化

- [ ] 单元测试
  - 测试站点注册表功能
  - 测试各站点爬虫功能
  - 测试下载器多站点支持

- [ ] 集成测试
  - 测试完整的下载流程
  - 测试站点切换功能
  - 测试配置更新功能

- [ ] 性能优化
  - 优化站点加载速度
  - 优化下载链接获取速度
  - 优化内存使用

- [ ] 错误处理
  - 添加站点加载失败处理
  - 添加下载失败重试逻辑
  - 添加详细的错误日志

---

## 第七阶段：文档和部署

- [ ] 更新技术文档
  - 更新架构图反映多站点支持
  - 添加站点开发指南
  - 更新 API 文档

- [ ] 更新用户文档
  - 更新 README 说明多站点支持
  - 添加站点配置说明
  - 添加常见问题解答

- [ ] Docker 镜像更新
  - 更新 Dockerfile 包含新代码
  - 更新 docker-compose 配置
  - 测试容器化部署

- [ ] 版本发布
  - 更新版本号
  - 创建发布说明
  - 打包发布

---

## 附录：技术要点

### 核心设计原则

1. **开闭原则**: 对扩展开放，对修改关闭
2. **单一职责**: 每个站点模块只负责一个网站
3. **依赖倒置**: 依赖抽象而非具体实现
4. **接口隔离**: 提供最小必要的接口

### 关键技术栈

- Python 抽象基类 (ABC)
- 动态模块加载 (importlib)
- 配置管理 (PyYAML)
- 类型注解 (typing)

### 预期收益

- 可扩展性: 添加新网站只需创建新模块
- 可维护性: 每个网站独立，互不影响
- 灵活性: 用户可选择启用/禁用特定网站
- 可测试性: 每个爬虫可独立测试

---

## 备注

- 每个阶段完成后应进行代码审查
- 保持向后兼容性，确保现有功能不受影响
- 优先实现核心功能，次要功能可后续迭代
- 及时更新文档和注释
