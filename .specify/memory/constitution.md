<!--
同步影响报告
====================
版本变更: 无 → 1.0.0
修改的原则: 无（初始创建）
新增章节:
  - 原则一：代码质量标准
  - 原则二：测试标准
  - 原则三：用户体验一致性
  - 原则四：性能要求
  - 原则五：安全与隐私
  - 原则六：文档与可维护性
移除章节: 无
需要更新的模板:
  ✅ .specify/templates/plan-template.md - 待创建
  ✅ .specify/templates/spec-template.md - 待创建
  ✅ .specify/templates/tasks-template.md - 待创建
  ✅ .claude/commands/speckit.plan.md - 需验证
  ✅ .claude/commands/speckit.specify.md - 需验证
  ✅ .claude/commands/speckit.tasks.md - 需验证
待办事项: 无
-->

# Stacks 项目宪法

## 版本信息

- **版本**: 1.0.0
- **批准日期**: 2025-12-25
- **最后修订日期**: 2025-12-25

## 项目概述

Stacks 是一个为 Anna's Archive 设计的容器化下载队列管理器，提供美观的 Web 界面用于排队、管理和自动下载图书。本宪法定义了项目开发的核心原则和标准，确保代码质量、测试覆盖、用户体验一致性和性能优化。

---

## 原则一：代码质量标准

### 核心要求

所有代码必须遵循以下质量标准：

1. **代码风格一致性**
   - Python 代码必须遵循 PEP 8 规范
   - JavaScript 代码必须遵循 ESLint 配置的规则
   - SCSS 代码必须遵循 BEM 命名约定
   - 所有文件必须使用 UTF-8 编码

2. **类型安全**
   - Python 代码必须使用类型注解（Type Hints）
   - 所有公共 API 必须包含完整的类型声明
   - 使用 mypy 进行静态类型检查

3. **代码审查**
   - 所有代码变更必须经过代码审查
   - 审查者必须检查代码质量、安全性和性能影响
   - 重大变更必须至少获得一名维护者的批准

4. **错误处理**
   - 所有可能失败的操作必须包含适当的异常处理
   - 错误消息必须清晰、可操作且包含足够的上下文
   - 禁止使用裸露的 `except:` 语句
   - 必须记录所有异常到日志系统

5. **代码复杂度**
   - 单个函数的圈复杂度不得超过 10
   - 单个文件的代码行数不得超过 500 行
   - 函数参数数量不得超过 5 个（超出时使用对象或字典）

### 理由

代码质量是项目长期可维护性的基础。一致的代码风格降低了认知负担，类型注解减少了运行时错误，严格的代码审查确保了代码质量，完善的错误处理提高了系统的健壮性，控制代码复杂度使代码更易于理解和测试。

---

## 原则二：测试标准

### 核心要求

所有代码变更必须包含相应的测试：

1. **测试覆盖率**
   - 核心业务逻辑的测试覆盖率必须达到 90% 以上
   - 整体代码库的测试覆盖率不得低于 80%
   - 使用 coverage.py 生成覆盖率报告

2. **测试类型**
   - **单元测试**: 测试单个函数和类的行为
   - **集成测试**: 测试模块之间的交互
   - **端到端测试**: 测试完整的用户工作流
   - **性能测试**: 测试关键路径的性能指标

3. **测试要求**
   - 所有新功能必须包含单元测试
   - 所有 bug 修复必须包含回归测试
   - 测试必须独立运行，不依赖外部服务（使用 mock）
   - 测试必须快速执行（单元测试 < 1 秒）

4. **测试命名**
   - 测试名称必须清晰描述被测试的行为
   - 使用 Given-When-Then 模式组织测试
   - 测试文件必须与被测试模块位于同一目录，命名为 `test_<module>.py`

5. **持续集成**
   - 所有测试必须在每次提交时自动运行
   - 测试失败必须阻止代码合并
   - 必须定期运行完整的测试套件（包括端到端测试）

### 理由

充分的测试覆盖是代码质量的保障。高覆盖率确保了核心功能的正确性，多种测试类型覆盖了不同层面的质量保证，独立的测试保证了可重复性，清晰的测试命名提高了可维护性，持续集成确保了代码变更不会引入回归。

---

## 原则三：用户体验一致性

### 核心要求

用户界面必须提供一致、直观和响应式的体验：

1. **界面一致性**
   - 所有页面必须使用统一的 Dracula 主题配色
   - 所有按钮和交互元素必须遵循一致的视觉风格
   - 所有图标必须使用 Remix Icon 库
   - 所有表单必须提供清晰的标签和验证反馈

2. **响应式设计**
   - 所有页面必须在桌面、平板和移动设备上正常显示
   - 使用断点：768px（平板）、1024px（桌面）
   - 关键操作必须在移动设备上易于访问

3. **交互反馈**
   - 所有异步操作必须提供加载指示器
   - 所有操作必须提供成功或失败的视觉反馈
   - 使用 Toast 通知显示非阻塞的消息
   - 关键操作必须提供确认对话框

4. **可访问性**
   - 所有交互元素必须可通过键盘访问
   - 所有图片必须包含 alt 文本
   - 颜色对比度必须符合 WCAG AA 标准
   - 表单必须与标签正确关联

5. **国际化支持**
   - 所有用户可见的文本必须支持多语言
   - 日期、时间和数字必须根据用户区域格式化
   - 文本方向必须支持从左到右和从右到左

### 理由

一致的用户界面降低了学习成本，响应式设计确保了多设备兼容性，及时的交互反馈提高了用户满意度，可访问性确保了所有用户都能使用应用，国际化支持扩大了用户群体。

---

## 原则四：性能要求

### 核心要求

系统必须满足以下性能标准：

1. **响应时间**
   - Web 界面 API 响应时间必须在 200ms 以内（P95）
   - 页面加载时间必须在 1 秒以内（首次内容绘制）
   - 下载队列操作响应时间必须在 100ms 以内

2. **并发处理**
   - 系统必须支持至少 100 个并发用户
   - 下载队列必须支持至少 50 个并发下载任务
   - Web 服务器必须使用 Gunicorn 并配置适当的工作进程数

3. **资源使用**
   - 单个下载任务的内存使用不得超过 100MB
   - Web 服务器的内存使用不得超过 500MB
   - CPU 使用率在正常负载下不得超过 70%

4. **缓存策略**
   - 静态资源必须使用缓存破坏策略
   - API 响应必须使用适当的缓存头
   - 配置数据必须缓存并定期刷新

5. **数据库优化**
   - 所有查询必须使用适当的索引
   - 避免使用 N+1 查询模式
   - 批量操作必须使用批量 API

6. **性能监控**
   - 必须监控关键性能指标（响应时间、错误率、吞吐量）
   - 必须记录性能日志用于分析
   - 必须定期进行性能测试和优化

### 理由

良好的性能是用户体验的关键。快速的响应时间提高了用户满意度，高并发处理能力支持了规模化，合理的资源使用降低了运营成本，缓存策略减少了服务器负载，数据库优化提高了查询效率，性能监控确保了持续优化。

---

## 原则五：安全与隐私

### 核心要求

系统必须遵循安全最佳实践：

1. **认证与授权**
   - 所有密码必须使用 bcrypt 加盐哈希
   - 必须实现速率限制防止暴力破解（5 次失败锁定 10 分钟）
   - API 密钥必须使用安全的随机生成器（32 字符）
   - 必须实现基于角色的访问控制（管理员、下载者）

2. **会话管理**
   - 必须使用 HTTPOnly 和 Secure 标志设置 Cookie
   - 必须使用 SameSite 属性防止 CSRF 攻击
   - 会话必须设置合理的过期时间
   - 必须实现会话失效机制

3. **数据保护**
   - 所有敏感数据必须加密存储
   - 日志中不得记录敏感信息（密码、API 密钥）
   - 配置文件权限必须设置为 600
   - 必须实现数据备份和恢复机制

4. **输入验证**
   - 所有用户输入必须进行验证和清理
   - 必须防止 SQL 注入、XSS 和 CSRF 攻击
   - 文件上传必须验证类型和大小
   - URL 参数必须进行白名单验证

5. **网络安全**
   - 必须使用 HTTPS（通过反向代理）
   - 必须配置适当的 CORS 策略
   - 必须实现请求速率限制
   - 必须定期更新依赖项以修复安全漏洞

### 理由

安全是系统的基础。强认证和授权保护了系统访问，安全的会话管理防止了会话劫持，数据保护确保了用户隐私，输入验证防止了注入攻击，网络安全措施保护了系统免受网络攻击。

---

## 原则六：文档与可维护性

### 核心要求

代码和系统必须有完整的文档：

1. **代码文档**
   - 所有公共 API 必须包含 docstring（遵循 Google 风格）
   - 复杂逻辑必须包含内联注释
   - 所有配置项必须包含说明注释
   - 所有端点必须包含 API 文档

2. **项目文档**
   - 必须提供 README 包含项目概述和快速开始指南
   - 必须提供 API 文档（使用 OpenAPI/Swagger）
   - 必须提供部署文档
   - 必须提供故障排除指南

3. **变更日志**
   - 所有变更必须记录在 CHANGELOG.md 中
   - 变更必须遵循 Keep a Changelog 格式
   - 必须区分不兼容变更、新增功能和 bug 修复

4. **版本控制**
   - 必须使用语义化版本控制（Semantic Versioning）
   - 必须为每个发布打上 Git 标签
   - 必须维护版本分支策略

5. **依赖管理**
   - 必须在 requirements.txt 中明确所有依赖
   - 必须锁定依赖版本以确保可重现构建
   - 必须定期更新依赖项
   - 必须记录依赖项的安全漏洞

### 理由

完整的文档是项目可维护性的关键。代码文档帮助开发者理解代码，项目文档帮助用户快速上手，变更日志提供了透明的变更历史，版本控制确保了可追溯性，依赖管理确保了构建的可重现性。

---

## 治理

### 修订程序

1. 本宪法的任何修订必须经过以下流程：
   - 提出修订提案，说明修订理由和影响
   - 在团队内部讨论并获得共识
   - 更新版本号（遵循语义化版本控制）
   - 更新最后修订日期
   - 同步更新所有相关模板和文档

2. 重大修订（MAJOR 版本变更）必须获得所有维护者的批准。

3. 小修订（MINOR 版本变更）必须获得至少一名维护者的批准。

4. 补丁修订（PATCH 版本变更）可以由任何贡献者提出，经审查后合并。

### 合规审查

1. 每次代码合并前必须进行宪法合规性检查：
   - 代码是否符合代码质量标准
   - 是否包含足够的测试覆盖
   - 是否影响用户体验一致性
   - 是否满足性能要求
   - 是否遵循安全最佳实践
   - 是否包含必要的文档更新

2. 定期（每季度）进行全面的合规性审查，确保项目持续遵循本宪法。

### 版本策略

- **MAJOR**: 不兼容的治理原则变更或原则重新定义
- **MINOR**: 新增原则或章节，或实质性扩展指导原则
- **PATCH**: 澄清、措辞改进、拼写错误修复、非语义性改进

---

## 附录

### 工具和配置

项目使用以下工具确保宪法合规：

- **代码风格**: black, flake8, pylint
- **类型检查**: mypy
- **测试**: pytest, coverage.py
- **JavaScript 代码风格**: ESLint, Prettier
- **性能监控**: 自定义日志系统
- **文档**: Sphinx, OpenAPI/Swagger

### 参考资源

- [PEP 8 - Style Guide for Python Code](https://peps8.org/)
- [Semantic Versioning](https://semver.org/)
- [Keep a Changelog](https://keepachangelog.com/)
- [WCAG 2.1 Guidelines](https://www.w3.org/WAI/WCAG21/quickref/)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)

---

**本宪法是 Stacks 项目开发的基础准则，所有贡献者和维护者必须严格遵守。**
