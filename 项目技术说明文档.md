# Stacks - Anna's Archive 下载管理器技术说明文档

## 项目概述

Stacks 是一个专门为 Anna's Archive 设计的容器化下载队列管理器。它提供了一个美观的 Web 界面，用于排队、管理和自动下载图书。该系统支持 Anna's Archive 的快速下载 API，并具有自动回退到镜像站点的功能，确保在最少人工干预的情况下实现可靠下载。

### 核心特性

- **安全的 Web 界面** - 带有会话管理的密码保护仪表板
- **队列管理** - 通过浏览器一键将图书添加到下载队列
- **快速下载支持** - 利用 Anna's Archive 会员身份进行优先下载
- **自动回退机制** - 当快速下载不可用时自动回退到镜像站点
- **实时仪表板** - 监控下载、队列状态和历史记录
- **浏览器集成** - Tampermonkey 脚本直接在 Anna's Archive 页面添加下载按钮
- **Docker 就绪** - 使用 Docker Compose 轻松部署
- **美观 UI** - 德古拉主题界面，带实时进度跟踪
- **恢复支持** - 自动恢复中断的下载
- **下载历史** - 跟踪成功和失败的下载，支持重试功能

## 技术架构

### 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Web UI     │  │ Tampermonkey │  │   REST API   │     │
│  │  (HTML/JS)   │  │   扩展脚本    │  │   接口       │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        应用服务层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Flask      │  │  下载队列     │  │  下载工作器   │     │
│  │   Web服务器   │  │   管理       │  │   (线程)     │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        下载引擎层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  快速下载     │  │  镜像下载     │  │ FlareSolverr │     │
│  │    API       │  │    引擎       │  │  代理服务     │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        数据存储层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   配置文件    │  │   队列数据    │  │   下载文件    │     │
│  │  (YAML)      │  │  (JSON)      │  │   存储       │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

### 技术栈

#### 后端技术
- **Python 3.11+** - 主要编程语言
- **Flask 3.1.2** - Web 框架，提供 API 和 Web 界面
- **Gunicorn 23.0.0** - 生产级 WSGI 服务器
- **bcrypt** - 密码哈希和验证
- **requests** - HTTP 客户端库
- **BeautifulSoup4** - HTML 解析
- **PyYAML** - 配置文件解析
- **Flask-CORS** - 跨域资源共享支持

#### 前端技术
- **HTML5** - 页面结构
- **SCSS** - CSS 预处理器，使用德古拉主题
- **JavaScript (ES6+)** - 前端交互逻辑
- **Remix Icon** - 图标库
- **Clipboard.js** - 剪贴板操作

#### 部署技术
- **Docker** - 容器化部署
- **Docker Compose** - 多容器编排
- **Alpine Linux** - 轻量级基础镜像
- **FlareSolverr** - Cloudflare 绕过服务

## 核心模块详解

### 1. 应用入口 (`src/stacks/main.py`)

**功能**: 应用程序的启动入口点，负责初始化和配置服务器。

**主要组件**:
- **参数解析**: 处理命令行参数（配置文件路径、调试模式）
- **目录初始化**: 确保必要的目录存在（配置、日志、下载目录）
- **配置加载**: 加载或创建配置文件
- **服务器启动**: 根据调试模式选择 Flask 开发服务器或 Gunicorn 生产服务器
- **信号处理**: 设置优雅关闭的信号处理器，确保资源正确释放

**关键流程**:
1. 解析命令行参数
2. 显示应用徽标和版本信息
3. 确保必要目录存在
4. 加载配置文件
5. 检查密码重置请求
6. 根据模式启动服务器（开发/生产）

### 2. Web 服务器 (`src/stacks/server/webserver.py`)

**功能**: 创建和配置 Flask 应用实例，设置所有必要的组件。

**主要组件**:
- **Flask 应用创建**: 配置模板、静态文件和 CORS
- **日志系统初始化**: 根据配置设置日志级别和格式
- **配置加载**: 加载应用配置
- **队列和工作线程初始化**: 创建下载队列和工作线程
- **API 路由注册**: 注册所有 API 端点
- **缓存破坏**: 注入时间戳确保静态文件更新

**关键流程**:
1. 确定配置文件路径
2. 设置日志系统
3. 创建 Flask 应用
4. 加载配置并设置会话密钥
5. 初始化下载队列和工作线程
6. 注册 API 路由
7. 返回配置完成的应用

### 3. 配置管理 (`src/stacks/config/config.py`)

**功能**: 提供线程安全的配置管理，包括加载、验证、保存和实时更新。

**主要组件**:
- **配置加载**: 从 YAML 文件加载配置
- **模式验证**: 根据预定义模式验证配置
- **默认值处理**: 为缺失的配置项提供默认值
- **登录凭据确保**: 确保系统有基本的登录凭据
- **线程安全**: 使用锁确保并发访问安全

**配置结构**:
```yaml
server:          # 服务器配置
  host: "0.0.0.0"
  port: 7788

login:           # 登录配置
  username: "admin"
  password: "hashed_password"
  disable: false

api:             # API 配置
  key: "admin_api_key"
  downloader_key: "downloader_api_key"
  session_secret: "session_secret"

downloads:       # 下载配置
  delay: 2
  retry_count: 3
  resume_attempts: 3
  prefer_title_naming: false
  include_hash: "none"
  incomplete_folder_path: "/download/incomplete"
  subdirectories: []

fast_download:   # 快速下载配置
  enabled: false
  key: "fast_download_key"

flaresolverr:    # FlareSolverr 配置
  enabled: false
  url: "http://localhost:8191"
  timeout: 60

queue:           # 队列配置
  max_history: 100

logging:         # 日志配置
  level: "INFO"
```

### 4. 安全认证 (`src/stacks/security/auth.py`)

**功能**: 提供用户认证、授权和安全防护功能。

**主要组件**:
- **密码哈希**: 使用 bcrypt 安全哈希密码
- **速率限制**: 防止暴力破解攻击（5次失败锁定10分钟）
- **会话管理**: Flask 会话管理
- **API 密钥验证**: 支持管理员和下载者两种权限级别的 API 密钥
- **权限装饰器**: 提供不同级别的访问控制

**安全机制**:
1. **密码安全**: 使用 bcrypt 加盐哈希
2. **速率限制**: IP 级别的登录尝试限制
3. **会话安全**: HTTPOnly cookie 和 SameSite 保护
4. **API 安全**: 32字符随机生成的 API 密钥
5. **权限分级**: 管理员全权限，下载者有限权限

### 5. 下载队列 (`src/stacks/server/queue.py`)

**功能**: 管理下载队列、当前下载和历史记录。

**主要组件**:
- **队列管理**: 添加、移除、获取队列项目
- **状态跟踪**: 跟踪当前下载状态
- **历史记录**: 维护下载历史，支持重试失败项目
- **持久化**: 将队列状态保存到磁盘
- **线程安全**: 使用锁确保并发访问安全

**队列状态**:
- **queued**: 等待下载
- **downloading**: 正在下载
- **completed**: 下载完成（成功或失败）
- **retry**: 重试失败的下载

### 6. 下载工作器 (`src/stacks/server/worker.py`)

**功能**: 后台线程，持续处理下载队列中的任务。

**主要组件**:
- **下载器初始化**: 创建 AnnaDownloader 实例
- **队列处理**: 从队列获取任务并执行下载
- **状态更新**: 更新下载进度和状态
- **错误处理**: 处理下载失败和重试逻辑
- **资源清理**: 下载完成后清理临时资源

**工作流程**:
1. 从队列获取下一个下载任务
2. 更新当前下载状态
3. 使用下载器执行下载
4. 处理下载结果（成功/失败）
5. 更新历史记录
6. 等待延迟时间后处理下一个任务

### 7. 下载引擎 (`src/stacks/downloader/`)

**功能**: 核心下载逻辑，支持多种下载方式和回退机制。

**主要组件**:
- **AnnaDownloader**: 主下载器类，协调所有下载功能
- **快速下载**: 使用 Anna's Archive 会员 API
- **镜像下载**: 从各种镜像站点下载
- **HTML 解析**: 解析下载页面获取链接
- **Cookie 管理**: 处理会话 Cookie
- **FlareSolverr 集成**: 绕过 Cloudflare 保护

**下载策略**:
1. **快速下载优先**: 如果启用且可用，使用快速下载 API
2. **镜像回退**: 快速下载失败时尝试镜像站点
3. **多源尝试**: 支持多个镜像站点作为备选
4. **断点续传**: 支持中断后继续下载
5. **文件验证**: 使用 MD5 验证下载完整性

## 前端界面详解

### 1. 主界面 (`web/index.html`)

**功能**: 主要的用户界面，提供下载管理功能。

**主要区域**:
- **头部**: 应用 Logo 和版本信息
- **导航标签**: 下载、设置、控制台三个主要功能区
- **统计信息**: 队列数量、完成数量、失败数量、快速下载状态
- **当前下载**: 显示正在进行的下载进度和状态
- **队列管理**: 显示等待下载的项目列表
- **历史记录**: 显示最近下载的项目和状态

### 2. 登录界面 (`web/login.html`)

**功能**: 用户认证界面，提供安全的登录功能。

**特点**:
- 简洁的登录表单
- 错误信息显示
- 自动聚焦用户名输入
- 响应式设计

### 3. JavaScript 应用 (`web/script/app.js`)

**功能**: 前端应用逻辑，处理用户交互和 API 通信。

**主要模块**:
- **API 客户端**: 与后端 API 通信
- **状态管理**: 维护前端应用状态
- **UI 更新**: 动态更新界面内容
- **事件处理**: 处理用户交互
- **实时更新**: 定期获取下载状态更新

## 部署和运维

### Docker 部署

**Dockerfile 特点**:
- 多阶段构建，减小最终镜像大小
- 使用 Alpine Linux 基础镜像
- 使用 PEX 打包 Python 应用
- 健康检查配置
- 非 root 用户运行支持

**部署步骤**:
1. 创建必要的目录（配置、下载、日志）
2. 配置 docker-compose.yml
3. 设置环境变量（用户名、密码、FlareSolverr URL）
4. 启动服务：`docker compose up -d`
5. 访问 Web 界面进行初始配置

### 配置管理

**关键配置项**:
- **服务器设置**: 主机、端口
- **认证设置**: 用户名、密码、API 密钥
- **下载设置**: 延迟、重试次数、文件命名
- **快速下载**: API 密钥、启用状态
- **FlareSolverr**: URL、超时设置
- **队列设置**: 最大历史记录数
- **日志设置**: 日志级别

### 监控和日志

**日志系统**:
- 结构化日志格式
- 多级别日志（DEBUG、INFO、WARNING、ERROR）
- 日志轮转支持
- Web 界面实时查看

**监控指标**:
- 队列长度
- 下载成功率
- 平均下载时间
- 错误率统计

## 安全考虑

### 认证和授权
- 强密码哈希（bcrypt）
- 会话管理（HTTPOnly cookies）
- API 密钥认证
- 速率限制防护
- 权限分级控制

### 数据保护
- 配置文件权限控制（600）
- API 密钥安全生成
- 敏感信息不记录到日志
- 安全的默认配置

### 网络安全
- CORS 配置
- HTTPS 支持（通过反向代理）
- 输入验证和清理
- 防止常见 Web 攻击

## 扩展和定制

### 添加新的下载源
1. 在 `downloader/mirrors.py` 中添加新的镜像站点处理逻辑
2. 更新配置模式以支持新站点
3. 在前端界面添加相关选项

### 自定义 UI 主题
1. 修改 `web/scss/` 中的 SCSS 文件
2. 更新 CSS 变量定义
3. 重新编译 CSS

### 添加新的 API 端点
1. 在 `src/stacks/api/` 中创建新的路由模块
2. 在 `__init__.py` 中注册新模块
3. 添加相应的认证和权限检查

## 故障排除

### 常见问题

**下载失败**:
- 检查网络连接
- 验证 FlareSolverr 配置
- 查看日志文件获取详细错误信息
- 尝试手动下载链接

**登录问题**:
- 检查用户名和密码
- 清除浏览器缓存和 Cookie
- 检查是否被速率限制锁定

**性能问题**:
- 调整下载延迟设置
- 减少并发下载数量
- 检查磁盘空间
- 监控系统资源使用

### 调试技巧

**启用调试模式**:
```bash
python -m stacks.main --debug
```

**查看详细日志**:
```bash
docker logs -f stacks
```

**检查配置**:
- 访问 Web 界面的设置页面
- 直接查看 `config/config.yaml` 文件
- 验证配置文件语法和权限    

## 总结

Stacks 是一个功能完整、设计良好的下载管理系统，具有以下优势：

1. **模块化设计**: 清晰的代码结构，易于维护和扩展
2. **安全可靠**: 多层安全防护，确保系统和数据安全
3. **用户友好**: 美观的界面和良好的用户体验
4. **容器化部署**: 简化部署和运维流程
5. **高可用性**: 自动重试、断点续传、多源下载
6. **可扩展性**: 支持添加新的下载源和功能

该项目展示了现代 Web 应用的最佳实践，包括 RESTful API 设计、前后端分离、容器化部署、安全认证等方面，是一个优秀的开源项目参考。