# Stacks 项目需求大纲

## 项目概述

**项目名称**: Stacks - Anna's Archive 下载管理器  
**项目类型**: 容器化下载队列管理系统  
**当前版本**: 基于 Docker 的稳定版本  
**创建日期**: 2025-12-25

## 核心功能需求

### 1. 用户认证与授权系统

**需求描述**: 提供安全的多层次认证机制，支持不同权限级别的用户访问

**子需求**:
- 1.1 Web 界面登录认证（基于会话）
- 1.2 Admin API Key 认证（完全访问权限）
- 1.3 Downloader API Key 认证（受限访问权限）
- 1.4 密码哈希与验证（使用 bcrypt）
- 1.5 会话管理与超时控制
- 1.6 API 密钥生成、禁用与重新生成
- 1.7 密码重置机制

**优先级**: 高

---

### 2. 下载队列管理系统

**需求描述**: 提供灵活的下载队列管理功能，支持添加、移除、暂停和恢复下载任务

**子需求**:
- 2.1 添加下载任务到队列（通过 MD5 标识）
- 2.2 从队列中移除指定任务
- 2.3 清空整个下载队列
- 2.4 暂停/恢复下载工作器
- 2.5 取消当前下载并重新排队
- 2.6 取消当前下载并从队列中移除
- 2.7 子目录管理与选择
- 2.8 队列优先级管理
- 2.9 队列状态实时监控

**优先级**: 高

---

### 3. 下载引擎系统

**需求描述**: 实现高效可靠的下载引擎，支持多种下载源和自动回退机制

**子需求**:
- 3.1 快速下载 API 支持（Anna's Archive 会员）
- 3.2 镜像站点下载引擎
- 3.3 自动回退机制（快速下载失败时自动切换到镜像）
- 3.4 下载中断恢复支持
- 3.5 下载重试机制（可配置重试次数）
- 3.6 下载进度跟踪
- 3.7 下载速度监控
- 3.8 多源下载支持（镜像站点列表）

**优先级**: 高

---

### 4. Web 界面与实时监控

**需求描述**: 提供美观、响应式的 Web 界面，实时显示下载状态和系统信息

**子需求**:
- 4.1 主仪表板界面（下载监控）
- 4.2 设置管理界面
- 4.3 实时进度显示（每 2 秒更新）
- 4.4 当前下载进度条与百分比
- 4.5 队列大小与待下载任务显示
- 4.6 下载历史记录显示
- 4.7 快速下载配额显示
- 4.8 德古拉主题 UI 设计
- 4.9 响应式布局支持
- 4.10 登录界面

**优先级**: 高

---

### 5. 配置管理系统

**需求描述**: 提供灵活的配置管理，支持通过 Web 界面和配置文件进行设置

**子需求**:
- 5.1 服务器配置（主机、端口）
- 5.2 登录配置（用户名、密码、禁用选项）
- 5.3 API 配置（密钥、会话密钥）
- 5.4 下载配置（延迟、重试次数、恢复尝试次数）
- 5.5 快速下载配置（启用状态、API 密钥）
- 5.6 FlareSolverr 配置（启用状态、URL、超时）
- 5.7 队列配置（最大历史记录数）
- 5.8 日志配置（日志级别）
- 5.9 配置实时重载（无需重启）
- 5.10 配置验证与测试

**优先级**: 高

---

### 6. RESTful API 接口系统

**需求描述**: 提供完整的 RESTful API，支持第三方集成和自动化操作

**子需求**:
- 6.1 系统端点（健康检查、版本信息、日志获取、状态查询）
- 6.2 认证与密钥管理端点
- 6.3 队列管理端点（添加、移除、清空、暂停、取消）
- 6.4 历史记录管理端点（清空、重试）
- 6.5 配置管理端点（获取、更新、测试）
- 6.6 子目录列表端点
- 6.7 API 密钥权限控制
- 6.8 请求验证与错误处理
- 6.9 CORS 支持

**优先级**: 高

---

### 7. 下载历史与重试机制

**需求描述**: 跟踪所有下载记录，支持查看历史和重试失败的下载

**子需求**:
- 7.1 成功下载记录
- 7.2 失败下载记录
- 7.3 下载历史显示（最多 N 条记录）
- 7.4 失败下载重试功能
- 7.5 历史记录清空功能
- 7.6 下载状态标记（成功/失败/进行中）
- 7.7 下载时间戳记录
- 7.8 下载文件信息记录

**优先级**: 中

---

### 8. FlareSolverr 集成

**需求描述**: 集成 FlareSolverr 代理服务，绕过 Cloudflare 和 DDoS-Guard 保护

**子需求**:
- 8.1 FlareSolverr 连接配置
- 8.2 自动使用 FlareSolverr（遇到 403 错误时）
- 8.3 Cookie 缓存（每域名 24 小时）
- 8.4 Cookie 预热（启动时自动刷新）
- 8.5 FlareSolverr 超时控制
- 8.6 连接测试功能
- 8.7 启用/禁用控制

**优先级**: 中

---

### 9. 浏览器扩展集成（Tampermonkey）

**需求描述**: 提供 Tampermonkey 用户脚本，在 Anna's Archive 页面直接添加下载按钮

**子需求**:
- 9.1 下载按钮注入到图书页面
- 9.2 一键添加到下载队列
- 9.3 服务器地址配置
- 9.4 API 密钥配置
- 9.5 子目录选择功能
- 9.6 下载状态反馈
- 9.7 跨域请求支持
- 9.8 错误处理与提示

**优先级**: 中

---

### 10. 日志与监控系统

**需求描述**: 提供完整的日志记录和系统监控功能

**子需求**:
- 10.1 多级别日志记录（DEBUG、INFO、WARN、ERROR）
- 10.2 日志文件管理
- 10.3 系统日志 API 端点（获取最近 N 行）
- 10.4 下载日志记录
- 10.5 错误日志记录
- 10.6 日志级别配置
- 10.7 日志轮转支持

**优先级**: 中

---

### 11. 容器化部署系统

**需求描述**: 提供完整的 Docker 容器化部署方案

**子需求**:
- 11.1 Docker 镜像构建
- 11.2 Docker Compose 配置
- 11.3 卷挂载配置（配置、下载、日志目录）
- 11.4 环境变量配置
- 11.5 网络配置
- 11.6 端口映射配置
- 11.7 重启策略配置
- 11.8 停止信号与优雅关闭
- 11.9 FlareSolverr 服务集成

**优先级**: 高

---

### 12. 安全与隐私保护

**需求描述**: 确保系统安全性和用户隐私保护

**子需求**:
- 12.1 密码哈希存储（bcrypt）
- 12.2 API 密钥安全存储
- 12.3 会话安全管理
- 12.4 输入验证与清理
- 12.5 CSRF 保护
- 12.6 HTTPS 支持（可选）
- 12.7 敏感信息日志过滤
- 12.8 访问控制

**优先级**: 高

---

## 非功能性需求

### 性能要求
- 支持并发下载（可配置并发数）
- 下载队列响应时间 < 1 秒
- Web 界面实时更新延迟 < 2 秒
- API 响应时间 < 500ms

### 可用性要求
- 系统可用性 > 99%
- 自动恢复中断的下载
- 优雅的错误处理
- 用户友好的错误提示

### 可维护性要求
- 模块化架构设计
- 代码注释与文档
- 配置文件结构清晰
- 日志记录完整

### 可扩展性要求
- 支持添加新的镜像站点
- 支持插件化下载引擎
- API 接口可扩展
- 配置项可扩展

---

## 需求优先级总结

### 高优先级（必须实现）
1. 用户认证与授权系统
2. 下载队列管理系统
3. 下载引擎系统
4. Web 界面与实时监控
5. 配置管理系统
6. RESTful API 接口系统
11. 容器化部署系统
12. 安全与隐私保护

### 中优先级（重要功能）
7. 下载历史与重试机制
8. FlareSolverr 集成
9. 浏览器扩展集成（Tampermonkey）
10. 日志与监控系统

---

## 下一步计划

根据本需求大纲，将为每个核心功能需求创建详细的需求规格说明书，遵循项目宪章中定义的原则和标准。

**创建顺序**（按优先级）:
- [X]  用户认证与授权系统
- [X]  下载队列管理系统
- [X]  下载引擎系统
- [X]  Web 界面与实时监控
- [X]  配置管理系统
- [X]  RESTful API 接口系统
- [X]  下载历史与重试机制
- [X]  FlareSolverr 集成
- [X]  浏览器扩展集成（Tampermonkey）
- [X]  日志与监控系统
- [X]  容器化部署系统
- [X]  安全与隐私保护